# Обоснование конфигурации инфраструктуры

## 1. Выбор ресурсов и параметров

### 1.1. Виртуальная сеть (VPC)

**Ресурс**: `yandex_vpc_network`

**Параметры**:

- CIDR: `10.0.0.0/16` — предоставляет достаточное адресное пространство для всех доменов (до 65534 IP-адресов)
- Разделение на подсети по доменам обеспечивает изоляцию и соответствие требованиям безопасности

**Обоснование**: Централизованная сеть позволяет доменам взаимодействовать через контролируемые интерфейсы, при этом
сохраняется изоляция данных между медицинским и финансовым доменами для соответствия регуляторным требованиям.

### 1.2. Подсети (Subnets)

**Ресурс**: `yandex_vpc_subnet`

**Параметры**:

- Medical Subnet: `10.0.2.0/24` (256 адресов) — зона `ru-central1-a`
- Fintech Subnet: `10.0.3.0/24` (256 адресов) — зона `ru-central1-b`
- AI Services Subnet: `10.0.4.0/24` (256 адресов) — зона `ru-central1-a`
- Analytics Subnet: `10.0.5.0/24` (256 адресов) — зона `ru-central1-b`
- Shared Services Subnet: `10.0.6.0/24` (256 адресов) — зона `ru-central1-a`
- Public Subnet: `10.0.1.0/24` (256 адресов) — зона `ru-central1-a`

**Обоснование**:

- Разделение подсетей по доменам соответствует архитектуре Domain-Driven Design и обеспечивает сетевую изоляцию
- Распределение между зонами `ru-central1-a` и `ru-central1-b` повышает отказоустойчивость
- Размер подсетей (256 адресов) достаточен для начального развёртывания и позволяет масштабирование внутри домена

### 1.3. NAT Gateway

**Ресурс**: `yandex_vpc_gateway` (NAT Gateway)

**Параметры**:

- Размещён в public subnet
- Используется для обеспечения исходящего интернет-трафика из приватных подсетей

**Обоснование**:

- Позволяет виртуальным машинам в приватных подсетях получать обновления, загружать пакеты и взаимодействовать с
  внешними API
- Исключает необходимость присваивать публичные IP-адреса каждой VM, повышая безопасность
- Централизованное управление исходящим трафиком упрощает мониторинг и контроль доступа

### 1.4. Группы безопасности (Security Groups)

**Ресурсы**: `yandex_vpc_security_group`

**Параметры**:

#### Medical Domain Security Group

- Входящий трафик: PostgreSQL (5432) из медицинской и shared-services подсетей
- Входящий трафик: SSH (22) для администрирования
- Исходящий трафик: разрешён весь

#### Fintech Domain Security Group

- Входящий трафик: PostgreSQL (5432) из финтех и shared-services подсетей
- Входящий трафик: SSH (22) для администрирования
- Исходящий трафик: разрешён весь

#### AI Services Security Group

- Входящий трафик: API (8000) из медицинской и shared-services подсетей
- Входящий трафик: SSH (22) для администрирования
- Исходящий трафик: разрешён весь

#### Analytics Security Group

- Входящий трафик: Analytics Portal (8080) из shared-services подсети
- Входящий трафик: SSH (22) для администрирования
- Исходящий трафик: разрешён весь

#### Shared Services Security Group

- Входящий трафик: API Gateway (8080) из shared-services, медицинской и финтех подсетей
- Входящий трафик: Identity Provider (9090) из shared-services подсети
- Входящий трафик: SSH (22) для администрирования
- Исходящий трафик: разрешён весь

**Обоснование**:

- Минимально необходимый набор правил обеспечивает принцип наименьших привилегий
- Изоляция трафика между доменами повышает безопасность
- Доступ к базам данных ограничен только необходимыми подсетями

### 1.5. Виртуальные машины

#### Medical DB VM

- **Платформа**: `standard-v2`
- **Процессоры**: 4 vCPU
- **Память**: 8 GB RAM
- **Диск**: 50 GB SSD
- **Core Fraction**: 100% (гарантированная производительность)

**Обоснование**:

- 4 vCPU и 8 GB RAM достаточно для работы PostgreSQL с начальной нагрузкой медицинского домена
- 50 GB диска обеспечивает хранение данных и логов на начальном этапе
- 100% core fraction гарантирует стабильную производительность для критичных медицинских данных

#### Fintech DB VM

- **Платформа**: `standard-v2`
- **Процессоры**: 4 vCPU
- **Память**: 8 GB RAM
- **Диск**: 50 GB SSD
- **Core Fraction**: 100%

**Обоснование**:

- Аналогичные требования к производительности, как у Medical DB, из-за критичности финансовых данных
- Гарантированная производительность (100%) необходима для соответствия банковским требованиям

#### AI Services VM

- **Платформа**: `standard-v2`
- **Процессоры**: 8 vCPU
- **Память**: 16 GB RAM
- **Диск**: 100 GB SSD
- **Core Fraction**: 100%

**Обоснование**:

- Увеличенное количество процессоров (8 vCPU) необходимо для обработки машинного обучения
- 16 GB RAM достаточно для работы с моделями ML среднего размера
- 100 GB диска позволяет хранить модели и данные для обучения

#### Analytics VM

- **Платформа**: `standard-v2`
- **Процессоры**: 8 vCPU
- **Память**: 32 GB RAM
- **Диск**: 200 GB SSD
- **Core Fraction**: 100%

**Обоснование**:

- 32 GB RAM необходимо для обработки больших объёмов аналитических данных и работы с витринами данных
- 8 vCPU обеспечивает параллельную обработку запросов
- 200 GB диска позволяет хранить агрегированные данные и кэши

#### Shared Services VM

- **Платформа**: `standard-v2`
- **Процессоры**: 2 vCPU
- **Память**: 4 GB RAM
- **Диск**: 30 GB SSD
- **Core Fraction**: 100%

**Обоснование**:

- Минимальная конфигурация достаточна для API Gateway и Identity Provider
- Масштабирование возможно при необходимости

### 1.6. Диски

**Тип диска**: `network-ssd`

**Обоснование**:

- Network SSD обеспечивает высокую производительность IOPS для баз данных и аналитических систем
- Достаточная надёжность для критичных систем
- Баланс между производительностью и стоимостью

### 1.7. Зоны доступности

**Распределение**:

- Зона `ru-central1-a`: Medical, AI Services, Shared Services
- Зона `ru-central1-b`: Fintech, Analytics

**Обоснование**:

- Распределение критичных доменов (Medical и Fintech) по разным зонам повышает отказоустойчивость
- Снижает риск одновременного отказа всех компонентов домена

## 2. Декларативный подход

### 2.1. Преимущества декларативного подхода (Terraform)

**Воспроизводимость**:

- Инфраструктура определяется в коде, что позволяет точно воспроизводить окружения (dev, staging, prod)
- Исключает различия между окружениями из-за ручной настройки
- Версионирование инфраструктуры через Git позволяет отслеживать изменения

**Идемпотентность**:

- Terraform гарантирует, что повторное применение конфигурации приводит к одинаковому результату
- Снижает риск ошибок при повторном развёртывании

**Управление изменениями**:

- Все изменения проходят через код и могут быть проверены перед применением
- `terraform plan` показывает план изменений перед их применением
- Упрощает процесс review и approval изменений инфраструктуры

**Документация**:

- Код инфраструктуры служит актуальной документацией
- Легко понять текущее состояние инфраструктуры

## 3. Infrastructure as Code (IaC)

### 3.1. Воспроизводимость

**Проблема**: Ручное развёртывание инфраструктуры приводит к:

- Различиям между окружениями
- Невозможности быстро восстановить инфраструктуру
- Долгому процессу развёртывания новых окружений

**Решение через IaC**:

- Один и тот же код используется для всех окружений (dev, staging, prod)
- Восстановление инфраструктуры занимает минуты вместо дней
- Новые окружения создаются автоматически

**Пример**: Развёртывание тестового окружения для новой функциональности занимает не дни, а минуты через
`terraform apply`.

### 3.2. Масштабируемость

**Горизонтальное масштабирование**:

- Добавление новых виртуальных машин для домена — изменение переменной `vm_configs`
- Terraform автоматически создаст новые ресурсы с правильными настройками сети и безопасности

**Вертикальное масштабирование**:

- Изменение параметров VM (cores, memory, disk) — обновление конфигурации
- Terraform обновит существующие ресурсы или создаст новые с миграцией

**Примеры масштабирования**:

1. **Добавление нового домена** (например, Pharmaceutical):
   ```hcl
   pharmaceutical = {
     zone          = "ru-central1-b"
     subnet        = "pharmaceutical"
     cores         = 4
     memory        = 8
     ...
   }
   ```
   Terraform создаст подсеть, VM, security groups автоматически.

2. **Масштабирование Analytics**:
    - Увеличение памяти с 32 GB до 64 GB
    - Увеличение диска с 200 GB до 500 GB
    - Изменение в `vm_configs` → `terraform apply` → автоматическое обновление

### 3.3. Автоматизация и DevOps

**CI/CD интеграция**:

- Terraform может быть интегрирован в pipeline развёртывания
- Автоматическое создание тестовых окружений для каждого pull request
- Автоматическое развёртывание изменений после merge

**Версионирование**:

- Все изменения инфраструктуры версионируются в Git
- Возможность отката к предыдущим версиям
- История изменений для аудита

### 3.4. Управление конфигурацией

**Централизованное управление**:

- Все параметры инфраструктуры в одном месте
- Легко найти и изменить настройки
- Снижение риска ошибок конфигурации

**Параметризация**:

- Использование переменных позволяет легко адаптировать конфигурацию для разных окружений
- `terraform.tfvars` для конкретных значений окружения
- Пример файла для разных окружений (dev.tfvars, prod.tfvars)

## 4. Что управляется Terraform, а что разворачивается вручную

### 4.1. Управляется Terraform

**Сетевая инфраструктура**:

- VPC Network
- Subnets
- NAT Gateway
- Route Tables
- Security Groups

**Вычислительные ресурсы**:

- Virtual Machines (создание, конфигурация базовых параметров)
- Boot Disks
- Network Interfaces

**Преимущества**: Все ресурсы инфраструктуры управляются декларативно, что обеспечивает воспроизводимость и контроль
версий.

### 4.2. Разворачивается вручную

**Приложения и сервисы**:

- Установка и настройка PostgreSQL на VM баз данных
- Развёртывание Python ML сервисов на AI Services VM
- Настройка Data Warehouse и Analytics Engine на Analytics VM
- Установка API Gateway и Identity Provider на Shared Services VM

**Конфигурации баз данных**:

- Создание схем, таблиц, пользователей
- Настройка репликации и бэкапов
- Оптимизация производительности

**Мониторинг и логирование**:

- Установка систем мониторинга (Prometheus, Grafana)
- Настройка централизованного логирования (ELK Stack, Loki)
- Настройка алертов

**Безопасность**:

- Установка и настройка SSL/TLS сертификатов
- Настройка VPN для доступа к приватным ресурсам
- Настройка брандмауэров на уровне приложений

**Резервное копирование**:

- Настройка политик бэкапов для баз данных
- Настройка snapshots дисков
- Настройка репликации данных

**Обоснование разделения**:

- **Terraform управляет инфраструктурой** (compute, network, storage) — это основа, которая изменяется реже
- **Приложения разворачиваются вручную или через отдельные инструменты** (Ansible, Kubernetes, Docker) — это позволяет:
    - Более гибкую настройку приложений
    - Независимое обновление приложений без изменения инфраструктуры
    - Использование специализированных инструментов для управления приложениями (например, Helm для Kubernetes)

## 5. Заключение

Использование Terraform для управления инфраструктурой обеспечивает:

1. **Воспроизводимость**: Одинаковая инфраструктура для всех окружений
2. **Масштабируемость**: Легкое добавление ресурсов и новых доменов
3. **Надёжность**: Версионирование и контроль изменений
4. **Эффективность**: Автоматизация развёртывания и управления
5. **Соответствие требованиям**: Изоляция доменов, безопасность, производительность

Подход Infrastructure as Code является критически важным для компании "Будущее 2.0", которая планирует быстро
масштабироваться и добавлять новые бизнес-направления, сохраняя при этом высокий уровень надёжности и безопасности.
